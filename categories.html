<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dynamic Categories</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Firebase v9 compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #1A2234;
      box-sizing: border-box;
    }

    .top-bar {
      background-color: #1A2234;
      color: white;
      padding: 5px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
    }
    .top-bar .left a {
      margin-right: 20px;
      color: white;
      text-decoration: none;
    }
    .top-bar .right i {
      font-size: 18px;
      color: whitesmoke;
    }

    .navbar {
      position: static;
      display: flex;
      height: 40px;
      justify-content: space-between;
      align-items: center;
      padding: 4px 10px;
      background: linear-gradient(to right, #f2f2f2, #1a2234a2);
    }
    .navbar .logo {
      display: flex;
      align-items: center;
      font-weight: bold;
      font-size: 22px;
    }
    .navbar .logo img {
      height: 45px;
      margin-right: 10px;
    }
    .navbar .nav-links {
      margin-right: 340px;
      list-style: none;
      display: flex;
      gap: 25px;
    }
    .navbar .nav-links a {
      text-decoration: none;
      font-weight: bolder;
      color: #000000;
    }

    /*.search-box {
      padding-right: 10px;
      color:#e6e6e6;
      position: relative;
      display: flex;
      align-items: center;
    }
    .search-box input {
      display: none;
      border: 1px solid #ccc;
      padding: 5px;
      border-radius: 5px;
      transition: width 0.3s ease;
    }
    .search-box:hover input {
      display: inline-block;
      width: 150px;
    }
*/
    /* Sidebar */
    .sidebar {
      margin-top: 82px;
      height: 100%;
      width: 310px;
      position: fixed;
      top: 0;
      left: 0;
      background: #090D18;
      padding-top: 20px;
      color: rgba(203, 195, 195, 0.557);
      border: #ccc;
    }
    #categoryy{
      color: rgba(203, 195, 195, 0.557);
    }
    .sidebar h2 {
      text-align: center;
      margin-bottom: 20px;
      font-size: x-large ;
    }

    .sidebar ul {
      list-style: none;
      margin-top: 35px;
      padding: 0;
    }

    .sidebar ul li {
      padding: 12px 20px;
      border-bottom: 1.5px solid #ddd;
      cursor: pointer;
      width: 70%;
      margin: auto;
      transition: 0.3s;
    }

    .sidebar ul li:hover {
      background: #575757;
    }
    
    .sidebar ul li.active {
      background: #444;
    }

    /* Main content */
    .main {
      margin-left: 360px;
      padding: 20px;
    }
    
    h2{
      color: #ddd;
    }

    .category-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
    }

    .category-card {
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 10px;
      margin: 10px;
      padding: 15px;
      background: rgba(203, 195, 195, 0.557);
      transition: transform 0.2s;
    }

    .category-card:hover {
      transform: scale(1.05);
      cursor: pointer;
    }

    .category-card img {
      width: 100px;
      height: 100px;
      object-fit: contain;
      margin-bottom: 10px;
    }
    
    .back-btn {
      background: #7f8c8d;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 20px;
    }
    
    .back-btn:hover {
      background: #95a5a6;
    }
    
    .error {
      text-align: center;
      padding: 20px;
      color: #e74c3c;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #bdc3c7;
    }

    /* Auto-selected category highlight */
    .auto-selected {
      background: #2c3e50 !important;
      color: #ecf0f1 !important;
      border-left: 4px solid #3498db;
    }
  </style>
</head>
<body>

<!-- Top Info Bar -->
<div class="top-bar">
  <div class="left">
    <a href="mailto:sialconnect@gmail.com"><i class="fas fa-envelope"></i> sialconnect@gmail.com</a>
    <a href="https://maps.google.com/?q=Sialkot,Punjab,Pakistan" target="_blank"><i class="fas fa-map-marker-alt"></i> Sialkot, Punjab Pakistan</a>
  </div>
  <div class="right">
    <a href="profile.html"><i class="fas fa-user-circle"></i></a>
  </div>
</div>

<!-- Navigation Bar -->
<nav class="navbar">
  <div class="logo"><img src="logo.jpg" alt="SialConnect Logo"> SIALCONNECT </div>
  <ul class="nav-links">
    <li><a href="sialconnt.html">HOME</a></li>
    <li><a href="factories.html">FACTORY</a></li>
    <li><a href="categories.html">CATEGORY</a></li>
    <li><a href="aboutme.html">ABOUT US</a></li>
  </ul>

</nav>

<div class="container">
  <!-- Sidebar -->
  <div class="sidebar">
    <h2 id="categoryy">CATEGORIES</h2>
    <ul id="categoryList">
      <li class="loading">Loading categories...</li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main">
    <h2 id="pageTitle">Welcome! Select a category</h2>
    <div id="categoryContent" class="category-container"></div>
  </div>
</div>

<script>
  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCEA_n66W-Dt6eBoPe7QiaSUebEv8ctBaE",
    authDomain: "sialconnect-5efb5.firebaseapp.com",
    projectId: "sialconnect-5efb5",
    storageBucket: "sialconnect-5efb5.appspot.com",
    messagingSenderId: "660615885537",
    appId: "1:660615885537:web:27e04abd3396adfcde3da0"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Global variables
  let categoriesData = {};
  let currentCategory = null;
  let currentMainProduct = null;
  let autoSelectedCategory = null; // Track auto-selected category

  // Default category structure for fallback
  const defaultCategories = {
    'sports': {
      name: 'Sports Goods',
      items: [
        { 
          name: 'Soccer', 
          img: 'soccers.jpg', 
          sub: [
            { name: 'Football', img: 'football.jpg' },
            { name: 'Futsal', img: 'futsal.jpg' }
          ] 
        },
        { 
          name: 'HandBall', 
          img: 'hand ball.jpg', 
          sub: [
            { name: 'Indoor Handball', img: 'indoor-handball.jpg' },
            { name: 'Outdoor Handball', img: 'outdoor-handball.jpg' }
          ] 
        }
      ]
    },
    'leather': {
      name: 'Leather Goods',
      items: [
        { 
          name: 'Wallets', 
          img: 'wallet.webp',
          sub: [
            { name: 'Men Wallets', img: 'men-wallet.jpg' },
            { name: 'Women Wallets', img: 'women-wallet.jpg' }
          ] 
        },
        { 
          name: 'Bags', 
          img: 'bag.jpg',
          sub: [
            { name: 'Leather Handbags', img: 'handbag.jpg' },
            { name: 'Leather Backpacks', img: 'backpack.jpg' }
          ] 
        }
      ]
    },
    'surgical': {
      name: 'Surgical Goods',
      items: [
        { 
          name: 'Scissors', 
          img: 'scissor.webp',
          sub: [
            { name: 'Medical Scissors', img: 'medical-scissors.jpg' },
            { name: 'Surgical Scissors', img: 'surgical-scissors.jpg' }
          ] 
        },
        { 
          name: 'Scalpels', 
          img: 'scalpels.jpeg',
          sub: [
            { name: 'Disposable Scalpels', img: 'disposable-scalpels.jpg' },
            { name: 'Reusable Scalpels', img: 'reusable-scalpels.jpg' }
          ] 
        }
      ]
    },
    'music': {
      name: 'Musical Instruments',
      items: [
        { 
          name: 'Guitar', 
          img: 'guitor.jpeg',
          sub: [
            { name: 'Acoustic Guitar', img: 'acoustic-guitar.jpg' },
            { name: 'Electric Guitar', img: 'electric-guitar.jpg' }
          ] 
        },
        { 
          name: 'Violin', 
          img: 'violin.jpeg',
          sub: [
            { name: 'Classical Violin', img: 'classical-violin.jpg' },
            { name: 'Electric Violin', img: 'electric-violin.jpg' }
          ] 
        }
      ]
    },
    'textile': {
      name: 'Textile & Apparel',
      items: [
        { 
          name: 'Shirts', 
          img: 'shirts.webp',
          sub: [
            { name: 'Casual Shirts', img: 'casual-shirts.jpg' },
            { name: 'Formal Shirts', img: 'formal-shirts.jpg' }
          ] 
        },
        { 
          name: 'Shoes', 
          img: 'shoes.webp',
          sub: [
            { name: 'Sports Shoes', img: 'sports-shoes.jpg' },
            { name: 'Formal Shoes', img: 'formal-shoes.jpg' }
          ] 
        }
      ]
    },
    'cutlery': {
      name: 'Cutlery Production',
      items: [
        { 
          name: 'Knives', 
          img: 'knifes.jpeg',
          sub: [
            { name: 'Kitchen Knives', img: 'kitchen-knives.jpg' },
            { name: 'Hunting Knives', img: 'hunting-knives.jpg' }
          ] 
        },
        { 
          name: 'Spoons', 
          img: 'spoon.webp',
          sub: [
            { name: 'Steel Spoons', img: 'steel-spoons.jpg' },
            { name: 'Silver Spoons', img: 'silver-spoons.jpg' }
          ] 
        }
      ]
    }
  };

  // Load categories from Firebase or use defaults
  async function loadCategories() {
    try {
      const categoriesSnapshot = await db.collection('categories').get();
      
      if (categoriesSnapshot.empty) {
        console.log('No categories found in Firebase, using default categories...');
        categoriesData = defaultCategories;
      } else {
        categoriesData = {};
        categoriesSnapshot.forEach(doc => {
          categoriesData[doc.id] = doc.data();
        });
      }
      
      renderCategoryList();
      
      // Check for auto-navigation AFTER categories are fully loaded
      checkAutoNavigation();
      
    } catch (error) {
      console.error('Error loading categories:', error);
      categoriesData = defaultCategories;
      renderCategoryList();
      showError('Failed to load categories from server. Using default categories.');
      
      // Still check for auto-navigation with default categories
      checkAutoNavigation();
    }
  }

  // Check for auto-navigation from homepage using URL parameters
  function checkAutoNavigation() {
    const urlParams = new URLSearchParams(window.location.search);
    const selectedCategoryKey = urlParams.get('category');
    
    console.log('Checking auto-navigation for:', selectedCategoryKey);
    console.log('Available categories:', Object.keys(categoriesData));
    
    if (selectedCategoryKey && categoriesData[selectedCategoryKey]) {
      console.log('Exact match found, auto-navigating to:', selectedCategoryKey);
      autoSelectedCategory = selectedCategoryKey;
      showCategory(selectedCategoryKey, true);
    } else if (selectedCategoryKey) {
      console.log('Exact key not found, searching for partial matches...');
      
      // Try to find a matching category with different case or partial match
      const foundKey = Object.keys(categoriesData).find(key => {
        const categoryName = categoriesData[key].name.toLowerCase();
        const searchKey = selectedCategoryKey.toLowerCase();
        
        // Check if category name contains the search key
        return key.toLowerCase() === searchKey || 
               categoryName.includes(searchKey) || 
               searchKey.includes(key.toLowerCase());
      });
      
      if (foundKey) {
        console.log('Partial match found:', foundKey, 'for search:', selectedCategoryKey);
        autoSelectedCategory = foundKey;
        showCategory(foundKey, true);
      } else {
        console.log('No matching category found for:', selectedCategoryKey);
        console.log('Available categories and their names:');
        Object.entries(categoriesData).forEach(([key, data]) => {
          console.log(`Key: "${key}" -> Name: "${data.name}"`);
        });
        
        // Show error message
        const title = document.getElementById("pageTitle");
        const content = document.getElementById("categoryContent");
        title.innerText = "Category Not Found";
        content.innerHTML = `
          <div class="error">
            <h3>Category "${selectedCategoryKey}" not found</h3>
            <p>Available categories:</p>
            <ul style="text-align: left; color: #bdc3c7;">
              ${Object.entries(categoriesData).map(([key, data]) => 
                `<li><strong>${data.name}</strong> (key: ${key})</li>`
              ).join('')}
            </ul>
            <button class="back-btn" onclick="location.href='categories.html'">View All Categories</button>
          </div>
        `;
      }
    }
  }

  // Add default categories to Firebase
  async function addDefaultCategories() {
    const batch = db.batch();
    
    for (const [key, category] of Object.entries(defaultCategories)) {
      const categoryRef = db.collection('categories').doc(key);
      batch.set(categoryRef, category);
    }
    
    try {
      await batch.commit();
      console.log('Default categories added to Firebase');
    } catch (error) {
      console.error('Error adding default categories:', error);
    }
  }

  // Render category list in sidebar
  function renderCategoryList() {
    const categoryList = document.getElementById('categoryList');
    categoryList.innerHTML = '';

    if (Object.keys(categoriesData).length === 0) {
      categoryList.innerHTML = '<li class="error">No categories available</li>';
      return;
    }

    Object.entries(categoriesData).forEach(([key, category]) => {
      const li = document.createElement('li');
      li.innerHTML = `${category.name} <i class="fas fa-chevron-right" style="float: right;"></i>`;
      li.setAttribute('data-category-key', key);
      
      // Highlight auto-selected category
      if (autoSelectedCategory === key) {
        li.classList.add('auto-selected');
      }
      
      li.onclick = (e) => {
        showCategory(key);
        // Remove auto-selected class when manually clicked
        if (autoSelectedCategory) {
          document.querySelectorAll('.auto-selected').forEach(item => {
            item.classList.remove('auto-selected');
          });
          autoSelectedCategory = null;
        }
      };
      categoryList.appendChild(li);
    });
  }

  // Show main category (modified to handle auto-navigation)
  function showCategory(categoryKey, isAutoNavigation = false) {
    const category = categoriesData[categoryKey];
    if (!category) {
      console.error('Category not found:', categoryKey);
      return;
    }

    console.log('Showing category:', categoryKey, category); // Debug info

    currentCategory = categoryKey;
    currentMainProduct = null;
    
    // Update active state (only if not auto-navigation or if manually clicked)
    if (!isAutoNavigation) {
      document.querySelectorAll('.sidebar li').forEach(li => li.classList.remove('active'));
      const targetLi = document.querySelector(`[data-category-key="${categoryKey}"]`);
      if (targetLi) {
        targetLi.classList.add('active');
      }
    }

    const title = document.getElementById("pageTitle");
    const content = document.getElementById("categoryContent");

    title.innerText = category.name;
    content.innerHTML = "";
    content.className = "category-container";

    if (!category.items || category.items.length === 0) {
      console.log('No items in category:', categoryKey);
      content.innerHTML = '<div class="error">No items available in this category</div>';
      return;
    }

    console.log('Category items:', category.items); // Debug items

    category.items.forEach((item, index) => {
      console.log(`Item ${index}:`, item.name, 'Subcategories:', item.sub ? item.sub.length : 'none'); // Debug each item
      
      const div = document.createElement("div");
      div.className = "category-card";
      div.innerHTML = `
        <img src="${item.img}" onerror="this.src='https://via.placeholder.com/100'" alt="${item.name}">
        <p>${item.name}</p>
      `;

      // Check if item has subcategories
      if (item.sub && item.sub.length > 0) {
        div.onclick = () => showSubCategory(categoryKey, item);
        div.style.cursor = 'pointer';
        div.title = 'Click to view subcategories';
      } else {
        // If no subcategories, add a note
        div.innerHTML += '<small style="color: #666;">(No subcategories)</small>';
        div.style.cursor = 'default';
        console.log('No subcategories for item:', item.name);
      }

      content.appendChild(div);
    });

    // Show notification for auto-navigation
    if (isAutoNavigation) {
      const notification = document.createElement("div");
      notification.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        background: #2ecc71;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        font-size: 14px;
      `;
      notification.textContent = `Showing ${category.name} category`;
      document.body.appendChild(notification);
      
      // Remove notification after 3 seconds
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }
  }

  // Show subcategories (unchanged)
  function showSubCategory(categoryKey, item) {
    const title = document.getElementById("pageTitle");
    const content = document.getElementById("categoryContent");

    currentMainProduct = item.name;

    title.innerText = item.name + " Subcategories";
    content.innerHTML = "";
    content.className = "";

    // Back button
    const backBtn = document.createElement("button");
    backBtn.innerText = "← Back to " + categoriesData[categoryKey].name;
    backBtn.className = "back-btn";
    backBtn.onclick = () => showCategory(categoryKey);
    content.appendChild(backBtn);

    if (!item.sub || item.sub.length === 0) {
      const noItems = document.createElement("div");
      noItems.className = "error";
      noItems.textContent = "No subcategories available";
      content.appendChild(noItems);
      return;
    }

    // Create container for subcategory items
    const subContainer = document.createElement("div");
    subContainer.className = "category-container";

    // Show subcategory items with dynamic links
    item.sub.forEach(sub => {
      const div = document.createElement("div");
      div.className = "category-card";
      
      // Create the product link with parameters
      const productLink = `product1.html?category=${categoryKey}&product=${encodeURIComponent(item.name)}&subproduct=${encodeURIComponent(sub.name)}`;
      
      div.innerHTML = `
        <a href="${productLink}" style="text-decoration:none; color:inherit;">
          <img src="${sub.img}" onerror="this.src='https://via.placeholder.com/100'" alt="${sub.name}">
          <p>${sub.name}</p>
        </a>
      `;
      
      subContainer.appendChild(div);
    });

    content.appendChild(subContainer);
  }

  // Show error message
  function showError(message) {
    const content = document.getElementById("categoryContent");
    const errorDiv = document.createElement("div");
    errorDiv.className = "error";
    errorDiv.textContent = message;
    content.appendChild(errorDiv);
  }

  // Real-time listener for categories
  function setupRealtimeListener() {
    db.collection('categories').onSnapshot((snapshot) => {
      categoriesData = {};
      snapshot.forEach(doc => {
        categoriesData[doc.id] = doc.data();
      });
      renderCategoryList();
      
      // Refresh current category if it's being viewed
      if (currentCategory && categoriesData[currentCategory]) {
        if (currentMainProduct) {
          const category = categoriesData[currentCategory];
          const item = category.items.find(i => i.name === currentMainProduct);
          if (item) {
            showSubCategory(currentCategory, item);
          }
        } else {
          showCategory(currentCategory);
        }
      }
    }, (error) => {
      console.error('Error in real-time listener:', error);
    });
  }

  // Initialize the page
  document.addEventListener('DOMContentLoaded', function() {
    // Alert function removed - No more popup messages!
    
    loadCategories().then(() => {
      setupRealtimeListener();
    });
  });
</script>

</body>
</html>