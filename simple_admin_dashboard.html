<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SialConnect Admin Dashboard - Enhanced</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Firebase v9 compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <style>
    .sidebar { transition: all .3s ease; }
    .loading { display: none; }
    .loading.active { display: flex; }
    @media (max-width: 1024px){
      .sidebar{ transform: translateX(-100%); }
      .sidebar.active{ transform: translateX(0); }
    }
    .modal { display: none; }
    .modal.active { display: flex; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- Toast -->
  <div id="toast" class="fixed top-4 right-4 z-50 hidden">
    <div class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg" id="toastContent"></div>
  </div>

  <!-- Loading -->
  <div id="loadingSpinner" class="fixed inset-0 bg-black/40 items-center justify-center z-50 loading">
    <div class="bg-white p-6 rounded-lg shadow-lg flex items-center">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
      <span>Processing...</span>
    </div>
  </div>

  <!-- Edit Category Modal -->
  <div id="editCategoryModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Edit Category</h2>
        <button onclick="closeEditCategoryModal()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <input type="hidden" id="editCategoryKey">
        <input type="text" id="editCategoryName" placeholder="Category Name *" class="p-3 border rounded-lg col-span-2">
      </div>
      
      <h3 class="text-lg font-semibold mb-3">Items</h3>
      <div id="editItemsContainer"></div>
      
      <div class="flex gap-2 mb-4">
        <button type="button" onclick="addEditItem()" class="bg-green-600 text-white px-4 py-2 rounded">
          + Add Item
        </button>
        <button onclick="updateCategory()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
          Update Category
        </button>
      </div>
    </div>
  </div>

  <!-- Edit Product Modal -->
  <div id="editProductModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 w-full max-w-2xl">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Edit Product</h2>
        <button onclick="closeEditProductModal()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <input type="hidden" id="editProductId">
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <input type="text" id="editProductName" placeholder="Product Name *" class="p-3 border rounded-lg">
        <input type="text" id="editProductCategory" placeholder="Category *" class="p-3 border rounded-lg">
        <input type="text" id="editProductSubcategory" placeholder="Subcategory" class="p-3 border rounded-lg">
        <input type="text" id="editProducerCompany" placeholder="Producer Company *" class="p-3 border rounded-lg">
        <input type="number" id="editProductPrice" placeholder="Price" class="p-3 border rounded-lg">
        <input type="text" id="editProductImage" placeholder="Image URL" class="p-3 border rounded-lg">
      </div>
      
      <textarea id="editProductDescription" placeholder="Product Description" class="w-full p-3 border rounded-lg mb-4" rows="4"></textarea>
      
      <button onclick="updateProduct()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
        Update Product
      </button>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 w-96">
      <h2 class="text-2xl font-bold mb-6 text-center">Admin Login</h2>
      <div class="mb-4">
        <input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 border rounded-lg" />
      </div>
      <div class="mb-6">
        <input type="password" id="loginPassword" placeholder="Password" class="w-full p-3 border rounded-lg" />
      </div>
      <button onclick="handleLogin()" class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700">
        Login
      </button>
      <p class="text-sm text-gray-500 text-center mt-4">Use any email/password to create account</p>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div id="mainContent" class="hidden">
    <!-- Mobile Menu Button -->
    <button onclick="toggleSidebar()" class="lg:hidden fixed top-4 left-4 z-50 p-2 rounded-lg bg-blue-600 text-white">
      <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed left-0 top-0 h-full w-64 bg-gray-900 text-white p-6 lg:translate-x-0 z-40">
      <div class="flex items-center justify-center mb-8">
        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center mr-3">
          <i class="fas fa-industry"></i>
        </div>
        <h1 class="text-xl font-bold">SialConnect</h1>
      </div>
      
      <nav class="space-y-2">
        <a href="#" onclick="showSection('dashboard')" class="nav-link block p-3 rounded-lg bg-blue-600">
          <i class="fas fa-home mr-3"></i>Dashboard
        </a>
        <a href="#" onclick="showSection('categories')" class="nav-link block p-3 rounded-lg hover:bg-gray-800">
          <i class="fas fa-tags mr-3"></i>Categories
        </a>
        <a href="#" onclick="showSection('factories')" class="nav-link block p-3 rounded-lg hover:bg-gray-800">
          <i class="fas fa-industry mr-3"></i>Factories
        </a>
        
        <a href="#" onclick="showSection('events')" class="nav-link block p-3 rounded-lg hover:bg-gray-800">
          <i class="fas fa-calendar-alt mr-3"></i>Events
        </a>
        <a href="#" onclick="showSection('notifications')" class="nav-link block p-3 rounded-lg hover:bg-gray-800">
          <i class="fas fa-bell mr-3"></i>Notifications
        </a>
        <a href="#" onclick="showSection('users')" class="nav-link block p-3 rounded-lg hover:bg-gray-800">
          <i class="fas fa-users mr-3"></i>Users
        </a>
      </nav>

      <div class="absolute bottom-6 left-6 right-6">
        <button onclick="handleLogout()" class="w-full p-3 bg-red-600 rounded-lg hover:bg-red-700">
          <i class="fas fa-sign-out-alt mr-2"></i>Logout
        </button>
      </div>
    </aside>

    <!-- Main Content Area -->
    <main class="lg:ml-64 p-6">
      
      <!-- Dashboard Section -->
      <section id="dashboard" class="section">
        <h1 class="text-3xl font-bold mb-6">Dashboard</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-semibold mb-2">Total Categories</h3>
            <p class="text-3xl font-bold text-orange-600" id="categoryCount">0</p>
          </div>
          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-semibold mb-2">Total Factories</h3>
            <p class="text-3xl font-bold text-blue-600" id="factoryCount">0</p>
          </div>
          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-semibold mb-2">Total Users</h3>
            <p class="text-3xl font-bold text-purple-600" id="userCount">0</p>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-semibold mb-2">Active Events</h3>
            <p class="text-3xl font-bold text-indigo-600" id="eventCount">0</p>
          </div>
          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-semibold mb-2">Recent Notifications</h3>
            <p class="text-3xl font-bold text-pink-600" id="notificationCount">0</p>
          </div>
        </div>
      </section>

      <!-- Categories Section -->
      <section id="categories" class="section hidden">
        <h1 class="text-3xl font-bold mb-6">Category Management</h1>
        
        <!-- Add Category Form -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
          <h2 class="text-xl font-semibold mb-4">Add New Category</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <input type="text" id="categoryKey" placeholder="Category Key (e.g., sports) *" class="p-3 border rounded-lg">
            <input type="text" id="categoryName" placeholder="Category Name (e.g., Sports Goods) *" class="p-3 border rounded-lg">
          </div>
          
          <h3 class="text-lg font-semibold mb-3">Items</h3>
          <div id="itemsContainer">
            <div class="item-row border p-4 rounded-lg mb-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                <input type="text" placeholder="Item Name (e.g., Soccer)" class="item-name p-2 border rounded">
                <input type="text" placeholder="Item Image URL" class="item-img p-2 border rounded">
              </div>
              
              <h4 class="font-medium mb-2">Subcategories</h4>
              <div class="subcategories-container">
                <div class="subcategory-row grid grid-cols-1 md:grid-cols-6 gap-2 mb-2">
                  <input type="text" placeholder="Sub Name" class="sub-name p-2 border rounded text-sm">
                  <input type="text" placeholder="Sub Image URL" class="sub-img p-2 border rounded text-sm">
                  <input type="text" placeholder="Product Link" class="sub-link p-2 border rounded text-sm">
                  <input type="text" placeholder="Detail/Description" class="sub-detail p-2 border rounded text-sm">
                  <select class="sub-factory p-2 border rounded text-sm">
                    <option value="">Select Factory</option>
                  </select>
                  
                </div>
              </div>
              <button type="button" onclick="addSubcategory(this)" class="bg-gray-500 text-white px-3 py-1 rounded text-sm mr-2">
                + Add Subcategory
              </button>
              <button type="button" onclick="removeItem(this)" class="bg-red-500 text-white px-3 py-1 rounded text-sm">
                Remove Item
              </button>
            </div>
          </div>
          
          <div class="flex gap-2 mb-4">
            <button type="button" onclick="addItem()" class="bg-green-600 text-white px-4 py-2 rounded">
              + Add Item
            </button>
            <button onclick="saveCategory()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
              Save Category
            </button>
          </div>
        </div>

        <!-- Categories List -->
        <div class="bg-white p-6 rounded-lg shadow">
          <h2 class="text-xl font-semibold mb-4">All Categories</h2>
          <div id="categoriesList" class="space-y-4"></div>
        </div>
      </section>

      <!-- Factories Section -->
      <section id="factories" class="section hidden">
        <h1 class="text-3xl font-bold mb-6">Factory Management</h1>
        
        <!-- Add Factory Form -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
          <h2 class="text-xl font-semibold mb-4">Add New Factory</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <input type="text" id="factoryName" placeholder="Factory Name *" class="p-3 border rounded-lg">
            <input type="text" id="factoryCategory" placeholder="Category *" class="p-3 border rounded-lg">
            <input type="text" id="factoryAddress" placeholder="Address *" class="p-3 border rounded-lg">
            <input type="text" id="factoryPhone" placeholder="Phone *" class="p-3 border rounded-lg">
            <input type="email" id="factoryEmail" placeholder="Email *" class="p-3 border rounded-lg">
            <input type="url" id="factoryWebsite" placeholder="Website (optional)" class="p-3 border rounded-lg">
            <input type="url" id="factoryLogo" placeholder="Logo URL (optional)" class="p-3 border rounded-lg">
            <div class="flex items-center">
              <input type="file" id="factoryLogoFile" accept="image/*" onchange="handleFactoryLogoUpload()" class="hidden">
              <button type="button" onclick="document.getElementById('factoryLogoFile').click()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                <i class="fas fa-upload mr-2"></i>Upload Logo
              </button>
              <img id="factoryLogoPreview" src="" alt="" class="ml-4 w-16 h-16 object-cover rounded hidden">
            </div>
          </div>
          
          <button onclick="saveFactory()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
            Save Factory
          </button>
        </div>

        <!-- Factories List -->
        <div class="bg-white p-6 rounded-lg shadow">
          <h2 class="text-xl font-semibold mb-4">All Factories</h2>
          <div id="factoriesList" class="space-y-4"></div>
        </div>
      </section>

      

      <!-- Events Section -->
      <section id="events" class="section hidden">
        <h1 class="text-3xl font-bold mb-6">Event Management</h1>
        
        <!-- Add Event Form -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
          <h2 class="text-xl font-semibold mb-4">Create New Event</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <input type="text" id="eventTitle" placeholder="Event Title *" class="p-3 border rounded-lg">
            <select id="eventType" class="p-3 border rounded-lg">
              <option value="">Select Event Type *</option>
              <option value="exhibition">Exhibition</option>
              <option value="workshop">Workshop</option>
              <option value="conference">Conference</option>
              <option value="meeting">Meeting</option>
              <option value="sale">Sale/Discount</option>
              <option value="announcement">Announcement</option>
            </select>
            <input type="date" id="eventDate" placeholder="Event Date *" class="p-3 border rounded-lg">
            <input type="time" id="eventTime" placeholder="Event Time" class="p-3 border rounded-lg">
            <input type="text" id="eventLocation" placeholder="Location *" class="p-3 border rounded-lg">
            <input type="text" id="eventOrganizer" placeholder="Organizer" class="p-3 border rounded-lg">
          </div>
          
          <textarea id="eventDescription" placeholder="Event Description *" class="w-full p-3 border rounded-lg mb-4" rows="4"></textarea>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <input type="url" id="eventImage" placeholder="Event Image URL (optional)" class="p-3 border rounded-lg">
            <input type="url" id="eventRegistrationLink" placeholder="Registration Link (optional)" class="p-3 border rounded-lg">
          </div>
          
          <div class="flex items-center mb-4">
            <input type="checkbox" id="eventIsActive" checked class="mr-2">
            <label for="eventIsActive">Active Event</label>
          </div>
          
          <button onclick="saveEvent()" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700">
            <i class="fas fa-calendar-plus mr-2"></i>Create Event
          </button>
        </div>

        <!-- Events List -->
        <div class="bg-white p-6 rounded-lg shadow">
          <h2 class="text-xl font-semibold mb-4">All Events</h2>
          <div class="mb-4">
            <select id="eventFilter" onchange="loadEvents()" class="p-2 border rounded-lg">
              <option value="all">All Events</option>
              <option value="active">Active Events</option>
              <option value="past">Past Events</option>
            </select>
          </div>
          <div id="eventsList" class="space-y-4"></div>
        </div>
      </section>

      <!-- Notifications Section -->
      <section id="notifications" class="section hidden">
        <h1 class="text-3xl font-bold mb-6">Notification Management</h1>
        
        <!-- Send Notification Form -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
          <h2 class="text-xl font-semibold mb-4">Send New Notification</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <input type="text" id="notificationTitle" placeholder="Notification Title *" class="p-3 border rounded-lg">
            <select id="notificationType" class="p-3 border rounded-lg">
              <option value="">Select Type *</option>
              <option value="info">Information</option>
              <option value="alert">Alert</option>
              <option value="success">Success</option>
              <option value="warning">Warning</option>
              <option value="promotion">Promotion</option>
              <option value="update">Update</option>
            </select>
          </div>
          
          <textarea id="notificationMessage" placeholder="Notification Message *" class="w-full p-3 border rounded-lg mb-4" rows="3"></textarea>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <select id="notificationTarget" class="p-3 border rounded-lg">
              <option value="all">All Users</option>
              <option value="specific">Specific User</option>
              <option value="category">By Category Interest</option>
            </select>
            <input type="text" id="notificationTargetValue" placeholder="User Email or Category (if specific)" class="p-3 border rounded-lg">
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <select id="notificationPriority" class="p-3 border rounded-lg">
              <option value="low">Low Priority</option>
              <option value="medium">Medium Priority</option>
              <option value="high">High Priority</option>
              <option value="urgent">Urgent</option>
            </select>
            <input type="url" id="notificationLink" placeholder="Action Link (optional)" class="p-3 border rounded-lg">
          </div>
          
          <button onclick="sendNotification()" class="bg-pink-600 text-white px-6 py-3 rounded-lg hover:bg-pink-700">
            <i class="fas fa-paper-plane mr-2"></i>Send Notification
          </button>
        </div>

        <!-- Notifications History -->
        <div class="bg-white p-6 rounded-lg shadow">
          <h2 class="text-xl font-semibold mb-4">Notification History</h2>
          <div id="notificationsList" class="space-y-4"></div>
        </div>
      </section>

      <!-- Users Section -->
      <section id="users" class="section hidden">
        <h1 class="text-3xl font-bold mb-6">User Management</h1>
        <div class="bg-white p-6 rounded-lg shadow">
          <div id="usersList" class="space-y-4"></div>
        </div>
      </section>

    </main>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCEA_n66W-Dt6eBoPe7QiaSUebEv8ctBaE",
      authDomain: "sialconnect-5efb5.firebaseapp.com",
      projectId: "sialconnect-5efb5",
      storageBucket: "sialconnect-5efb5.appspot.com",
      messagingSenderId: "660615885537",
      appId: "1:660615885537:web:27e04abd3396adfcde3da0"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Helper Functions
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const content = document.getElementById('toastContent');
      content.textContent = message;
      content.className = type === 'error' ? 
        'bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg' : 
        'bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg';
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    function showLoading() {
      document.getElementById('loadingSpinner').classList.add('active');
    }

    function hideLoading() {
      document.getElementById('loadingSpinner').classList.remove('active');
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
    }

    function showSection(sectionName) {
      // Hide all sections
      document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
      // Show selected section
      document.getElementById(sectionName).classList.remove('hidden');
      
      // Update nav links
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('bg-blue-600');
        link.classList.add('hover:bg-gray-800');
      });
      event.target.closest('.nav-link').classList.add('bg-blue-600');
      event.target.closest('.nav-link').classList.remove('hover:bg-gray-800');
      
      // Load section data
      if (sectionName === 'dashboard') loadDashboard();
      if (sectionName === 'categories') {
        loadCategories();
        loadFactoriesDropdown();
      }
      if (sectionName === 'factories') loadFactories();
      if (sectionName === 'events') loadEvents();
      if (sectionName === 'notifications') loadNotifications();
      if (sectionName === 'users') loadUsers();
    }

    // Authentication Functions
    async function handleLogin() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      
      if (!email || !password) {
        showToast('Please enter email and password', 'error');
        return;
      }
      
      showLoading();
      
      try {
        await auth.signInWithEmailAndPassword(email, password);
        showToast('Login successful!');
      } catch (error) {
        if (error.code === 'auth/user-not-found') {
          try {
            await auth.createUserWithEmailAndPassword(email, password);
            showToast('Account created successfully!');
          } catch (createError) {
            hideLoading();
            showToast(createError.message, 'error');
          }
        } else {
          hideLoading();
          showToast(error.message, 'error');
        }
      }
    }

    function handleLogout() {
  auth.signOut().then(() => {
    showToast("You have been logged out!");
    // Redirect to signin.html page
    window.location.href = 'login.html';
  }).catch((error) => {
    console.error("Logout error:", error);
    showToast('Logout error: ' + error.message, 'error');
  });
}

    // Factory Dropdown Loading
    async function loadFactoriesDropdown() {
      try {
        const snapshot = await db.collection('factories').get();
        const selects = document.querySelectorAll('.sub-factory');
        
        selects.forEach(select => {
          // Clear existing options except first one
          while (select.children.length > 1) {
            select.removeChild(select.lastChild);
          }
          
          snapshot.forEach(doc => {
            const factory = doc.data();
            const option = document.createElement('option');
            option.value = doc.id;
            option.textContent = factory.name;
            select.appendChild(option);
          });
        });
      } catch (error) {
        console.error('Error loading factories:', error);
      }
    }

    // Category Management Functions
    function addItem() {
      const container = document.getElementById('itemsContainer');
      const itemDiv = document.createElement('div');
      itemDiv.className = 'item-row border p-4 rounded-lg mb-4';
      itemDiv.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
          <input type="text" placeholder="Item Name" class="item-name p-2 border rounded">
          <input type="text" placeholder="Item Image URL" class="item-img p-2 border rounded">
        </div>
        
        <h4 class="font-medium mb-2">Subcategories</h4>
        <div class="subcategories-container">
          <div class="subcategory-row grid grid-cols-1 md:grid-cols-6 gap-2 mb-2">
            <input type="text" placeholder="Sub Name" class="sub-name p-2 border rounded text-sm">
            <input type="text" placeholder="Sub Image URL" class="sub-img p-2 border rounded text-sm">
            <input type="text" placeholder="Product Link" class="sub-link p-2 border rounded text-sm">
            <input type="text" placeholder="Detail/Description" class="sub-detail p-2 border rounded text-sm">
            <select class="sub-factory p-2 border rounded text-sm">
              <option value="">Select Factory</option>
            </select>
            <input type="text" placeholder="Price" class="sub-price p-2 border rounded text-sm">
          </div>
        </div>
        <button type="button" onclick="addSubcategory(this)" class="bg-gray-500 text-white px-3 py-1 rounded text-sm mr-2">
          + Add Subcategory
        </button>
        <button type="button" onclick="removeItem(this)" class="bg-red-500 text-white px-3 py-1 rounded text-sm">
          Remove Item
        </button>
      `;
      container.appendChild(itemDiv);
      
      // Load factories for new dropdown
      loadFactoriesForSingleDropdown(itemDiv.querySelector('.sub-factory'));
    }

    function addEditItem() {
      const container = document.getElementById('editItemsContainer');
      const itemDiv = document.createElement('div');
      itemDiv.className = 'item-row border p-4 rounded-lg mb-4';
      itemDiv.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
          <input type="text" placeholder="Item Name" class="item-name p-2 border rounded">
          <input type="text" placeholder="Item Image URL" class="item-img p-2 border rounded">
        </div>
        
        <h4 class="font-medium mb-2">Subcategories</h4>
        <div class="subcategories-container">
          <div class="subcategory-row grid grid-cols-1 md:grid-cols-6 gap-2 mb-2">
            <input type="text" placeholder="Sub Name" class="sub-name p-2 border rounded text-sm">
            <input type="text" placeholder="Sub Image URL" class="sub-img p-2 border rounded text-sm">
            <input type="text" placeholder="Product Link" class="sub-link p-2 border rounded text-sm">
            <input type="text" placeholder="Detail/Description" class="sub-detail p-2 border rounded text-sm">
            <select class="sub-factory p-2 border rounded text-sm">
              <option value="">Select Factory</option>
            </select>
            <input type="text" placeholder="Price" class="sub-price p-2 border rounded text-sm">
          </div>
        </div>
        <button type="button" onclick="addSubcategory(this)" class="bg-gray-500 text-white px-3 py-1 rounded text-sm mr-2">
          + Add Subcategory
        </button>
        <button type="button" onclick="removeItem(this)" class="bg-red-500 text-white px-3 py-1 rounded text-sm">
          Remove Item
        </button>
      `;
      container.appendChild(itemDiv);
      loadFactoriesForSingleDropdown(itemDiv.querySelector('.sub-factory'));
    }

    function addSubcategory(button) {
      const container = button.parentElement.querySelector('.subcategories-container');
      const subDiv = document.createElement('div');
      subDiv.className = 'subcategory-row grid grid-cols-1 md:grid-cols-7 gap-2 mb-2';
      subDiv.innerHTML = `
        <input type="text" placeholder="Sub Name" class="sub-name p-2 border rounded text-sm">
        <input type="text" placeholder="Sub Image URL" class="sub-img p-2 border rounded text-sm">
        <input type="text" placeholder="Product Link" class="sub-link p-2 border rounded text-sm">
        <input type="text" placeholder="Detail/Description" class="sub-detail p-2 border rounded text-sm">
        <select class="sub-factory p-2 border rounded text-sm">
          <option value="">Select Factory</option>
        </select>
        <input type="text" placeholder="Price" class="sub-price p-2 border rounded text-sm">
        <button type="button" onclick="removeSubcategory(this)" class="bg-red-400 text-white px-2 py-1 rounded text-xs">Remove</button>
      `;
      container.appendChild(subDiv);
      loadFactoriesForSingleDropdown(subDiv.querySelector('.sub-factory'));
    }

    function removeItem(button) {
      button.parentElement.remove();
    }

    function removeSubcategory(button) {
      button.parentElement.remove();
    }

    async function loadFactoriesForSingleDropdown(selectElement) {
      try {
        const snapshot = await db.collection('factories').get();
        snapshot.forEach(doc => {
          const factory = doc.data();
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = factory.name;
          selectElement.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading factories for dropdown:', error);
      }
    }

    function clearCategoryForm() {
      document.getElementById('categoryKey').value = '';
      document.getElementById('categoryName').value = '';
      document.getElementById('itemsContainer').innerHTML = `
        <div class="item-row border p-4 rounded-lg mb-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
            <input type="text" placeholder="Item Name (e.g., Soccer)" class="item-name p-2 border rounded">
            <input type="text" placeholder="Item Image URL" class="item-img p-2 border rounded">
          </div>
          
          <h4 class="font-medium mb-2">Subcategories</h4>
          <div class="subcategories-container">
            <div class="subcategory-row grid grid-cols-1 md:grid-cols-6 gap-2 mb-2">
              <input type="text" placeholder="Sub Name" class="sub-name p-2 border rounded text-sm">
              <input type="text" placeholder="Sub Image URL" class="sub-img p-2 border rounded text-sm">
              <input type="text" placeholder="Product Link" class="sub-link p-2 border rounded text-sm">
              <input type="text" placeholder="Detail/Description" class="sub-detail p-2 border rounded text-sm">
              <select class="sub-factory p-2 border rounded text-sm">
                <option value="">Select Factory</option>
              </select>
              <input type="text" placeholder="Price" class="sub-price p-2 border rounded text-sm">
            </div>
          </div>
          <button type="button" onclick="addSubcategory(this)" class="bg-gray-500 text-white px-3 py-1 rounded text-sm mr-2">
            + Add Subcategory
          </button>
          <button type="button" onclick="removeItem(this)" class="bg-red-500 text-white px-3 py-1 rounded text-sm">
            Remove Item
          </button>
        </div>
      `;
      loadFactoriesDropdown();
    }

    async function saveCategory() {
      const categoryKey = document.getElementById('categoryKey').value.trim();
      const categoryName = document.getElementById('categoryName').value.trim();
      
      if (!categoryKey || !categoryName) {
        showToast('Please enter category key and name', 'error');
        return;
      }
      
      const items = [];
      const itemRows = document.querySelectorAll('#itemsContainer .item-row');
      const factoryProducts = new Map();
      
      itemRows.forEach(row => {
        const itemName = row.querySelector('.item-name').value.trim();
        const itemImg = row.querySelector('.item-img').value.trim();
        
        if (itemName) {
          const item = { 
            name: itemName, 
            img: itemImg || 'https://via.placeholder.com/100', 
            sub: [] 
          };
          
          const subRows = row.querySelectorAll('.subcategory-row');
          subRows.forEach(subRow => {
            const subName = subRow.querySelector('.sub-name').value.trim();
            const subImg = subRow.querySelector('.sub-img').value.trim();
            const subLink = subRow.querySelector('.sub-link').value.trim();
            const subDetail = subRow.querySelector('.sub-detail').value.trim();
            const subFactorySelect = subRow.querySelector('.sub-factory');
            const subFactoryId = subFactorySelect ? subFactorySelect.value : '';
            const subFactoryName = subFactorySelect && subFactoryId ? 
              subFactorySelect.options[subFactorySelect.selectedIndex].text : '';
            const subPrice = subRow.querySelector('.sub-price') ? 
              subRow.querySelector('.sub-price').value.trim() : '';
            
            if (subName) {
              const subItem = {
                name: subName,
                img: subImg || 'https://via.placeholder.com/100',
                link: subLink || 'product1.html',
                detail: subDetail || '',
                company: subFactoryName || '',
                factoryId: subFactoryId || '',
                price: subPrice || ''
              };
              
              item.sub.push(subItem);
              
              if (subFactoryId) {
                if (!factoryProducts.has(subFactoryId)) {
                  factoryProducts.set(subFactoryId, []);
                }
                factoryProducts.get(subFactoryId).push({
                  name: subName,
                  category: categoryName,
                  mainProduct: itemName,
                  image: subImg || 'https://via.placeholder.com/100',
                  description: subDetail || '',
                  price: subPrice || '',
                  categoryKey: categoryKey,
                  productPath: `${categoryKey}_${itemName}_${subName}`,
                  top: false
                });
              }
            }
          });
          
          items.push(item);
        }
      });
      
      try {
        showLoading();
        
        await db.collection('categories').doc(categoryKey).set({
          name: categoryName,
          items: items,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        const batch = db.batch();
        for (const [factoryId, products] of factoryProducts) {
          for (const product of products) {
            const productRef = db.collection('factories').doc(factoryId)
              .collection('products').doc();
            batch.set(productRef, {
              ...product,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        }
        await batch.commit();
        
        clearCategoryForm();
        showToast('Category and products saved successfully!');
        loadCategories();
        
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    async function loadCategories() {
      try {
        const snapshot = await db.collection('categories').orderBy('createdAt', 'desc').get();
        const list = document.getElementById('categoriesList');
        list.innerHTML = '';
        
        if (snapshot.empty) {
          list.innerHTML = '<p class="text-gray-500">No categories found</p>';
          return;
        }
        
        snapshot.forEach(doc => {
          const category = doc.data();
          const itemCount = category.items ? category.items.length : 0;
          let totalSubItems = 0;
          if (category.items) {
            category.items.forEach(item => {
              if (item.sub) totalSubItems += item.sub.length;
            });
          }
          
          list.innerHTML += `
            <div class="border p-4 rounded-lg">
              <div class="flex justify-between items-start">
                <div>
                  <h3 class="font-semibold text-lg">${category.name}</h3>
                  <p class="text-gray-600">Key: ${doc.id}</p>
                  <p class="text-sm text-gray-500">${itemCount} items, ${totalSubItems} sub-items</p>
                </div>
                <div class="flex gap-2">
                  <button onclick="editCategory('${doc.id}')" class="text-blue-500 hover:text-blue-700">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button onclick="deleteCategory('${doc.id}')" class="text-red-500 hover:text-red-700">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          `;
        });
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    }

    async function editCategory(id) {
      try {
        showLoading();
        const doc = await db.collection('categories').doc(id).get();
        if (!doc.exists) {
          showToast('Category not found', 'error');
          return;
        }
        
        const category = doc.data();
        document.getElementById('editCategoryKey').value = id;
        document.getElementById('editCategoryName').value = category.name;
        
        const container = document.getElementById('editItemsContainer');
        container.innerHTML = '';
        
        if (category.items && category.items.length > 0) {
          for (const item of category.items) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item-row border p-4 rounded-lg mb-4';
            
            let subcategoriesHTML = '';
            if (item.sub && item.sub.length > 0) {
              item.sub.forEach(sub => {
                subcategoriesHTML += `
                  <div class="subcategory-row grid grid-cols-1 md:grid-cols-7 gap-2 mb-2">
                    <input type="text" placeholder="Sub Name" class="sub-name p-2 border rounded text-sm" value="${sub.name || ''}">
                    <input type="text" placeholder="Sub Image URL" class="sub-img p-2 border rounded text-sm" value="${sub.img || ''}">
                    <input type="text" placeholder="Product Link" class="sub-link p-2 border rounded text-sm" value="${sub.link || ''}">
                    <input type="text" placeholder="Detail/Description" class="sub-detail p-2 border rounded text-sm" value="${sub.detail || ''}">
                    <select class="sub-factory p-2 border rounded text-sm">
                      <option value="">Select Factory</option>
                    </select>
                    <input type="text" placeholder="Price" class="sub-price p-2 border rounded text-sm" value="${sub.price || ''}">
                    <button type="button" onclick="removeSubcategory(this)" class="bg-red-400 text-white px-2 py-1 rounded text-xs">Remove</button>
                  </div>
                `;
              });
            }
            
            itemDiv.innerHTML = `
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                <input type="text" placeholder="Item Name" class="item-name p-2 border rounded" value="${item.name || ''}">
                <input type="text" placeholder="Item Image URL" class="item-img p-2 border rounded" value="${item.img || ''}">
              </div>
              
              <h4 class="font-medium mb-2">Subcategories</h4>
              <div class="subcategories-container">
                ${subcategoriesHTML}
              </div>
              <button type="button" onclick="addSubcategory(this)" class="bg-gray-500 text-white px-3 py-1 rounded text-sm mr-2">
                + Add Subcategory
              </button>
              <button type="button" onclick="removeItem(this)" class="bg-red-500 text-white px-3 py-1 rounded text-sm">
                Remove Item
              </button>
            `;
            container.appendChild(itemDiv);
            
            // Load factories for existing dropdowns
            const selects = itemDiv.querySelectorAll('.sub-factory');
            selects.forEach(select => loadFactoriesForSingleDropdown(select));
          }
        }
        
        document.getElementById('editCategoryModal').classList.add('active');
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    function closeEditCategoryModal() {
      document.getElementById('editCategoryModal').classList.remove('active');
    }

    async function updateCategory() {
      const categoryKey = document.getElementById('editCategoryKey').value;
      const categoryName = document.getElementById('editCategoryName').value.trim();
      
      if (!categoryName) {
        showToast('Please enter category name', 'error');
        return;
      }
      
      const items = [];
      const itemRows = document.querySelectorAll('#editItemsContainer .item-row');
      
      itemRows.forEach(row => {
        const itemName = row.querySelector('.item-name').value.trim();
        const itemImg = row.querySelector('.item-img').value.trim();
        
        if (itemName) {
          const item = { 
            name: itemName, 
            img: itemImg || 'https://via.placeholder.com/100', 
            sub: [] 
          };
          
          const subRows = row.querySelectorAll('.subcategory-row');
          subRows.forEach(subRow => {
            const subName = subRow.querySelector('.sub-name').value.trim();
            const subImg = subRow.querySelector('.sub-img').value.trim();
            const subLink = subRow.querySelector('.sub-link').value.trim();
            const subDetail = subRow.querySelector('.sub-detail').value.trim();
            const subFactorySelect = subRow.querySelector('.sub-factory');
            const subFactoryId = subFactorySelect ? subFactorySelect.value : '';
            const subFactoryName = subFactorySelect && subFactoryId ? 
              subFactorySelect.options[subFactorySelect.selectedIndex].text : '';
            const subPrice = subRow.querySelector('.sub-price') ? 
              subRow.querySelector('.sub-price').value.trim() : '';
            
            if (subName) {
              item.sub.push({
                name: subName,
                img: subImg || 'https://via.placeholder.com/100',
                link: subLink || 'product1.html',
                detail: subDetail || '',
                company: subFactoryName || '',
                factoryId: subFactoryId || '',
                price: subPrice || ''
              });
            }
          });
          
          items.push(item);
        }
      });
      
      try {
        showLoading();
        
        await db.collection('categories').doc(categoryKey).update({
          name: categoryName,
          items: items,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        closeEditCategoryModal();
        showToast('Category updated successfully!');
        loadCategories();
        
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    async function deleteCategory(id) {
      if (!confirm('Are you sure you want to delete this category?')) return;
      
      try {
        showLoading();
        await db.collection('categories').doc(id).delete();
        showToast('Category deleted successfully!');
        loadCategories();
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    // Factory Management Functions
    async function saveFactory() {
      const name = document.getElementById('factoryName').value.trim();
      const category = document.getElementById('factoryCategory').value.trim();
      const address = document.getElementById('factoryAddress').value.trim();
      const phone = document.getElementById('factoryPhone').value.trim();
      const email = document.getElementById('factoryEmail').value.trim();
      const website = document.getElementById('factoryWebsite').value.trim();
      const logo = document.getElementById('factoryLogo').value.trim();
      
      if (!name || !category || !address || !phone || !email) {
        showToast('Please fill all required fields', 'error');
        return;
      }
      
      try {
        showLoading();
        
        let logoUrl = logo;
        if (!logoUrl || logoUrl.length === 0) {
          logoUrl = 'https://via.placeholder.com/200x200?text=' + encodeURIComponent(name.substring(0, 2).toUpperCase());
        }
        
        await db.collection('factories').add({
          name,
          category,
          address,
          phone,
          email,
          website,
          logo: logoUrl,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Clear form
        ['factoryName', 'factoryCategory', 'factoryAddress', 'factoryPhone', 'factoryEmail', 'factoryWebsite', 'factoryLogo'].forEach(id => {
          document.getElementById(id).value = '';
        });
        
        if (document.getElementById('factoryLogoFile')) {
          document.getElementById('factoryLogoFile').value = '';
        }
        if (document.getElementById('factoryLogoPreview')) {
          document.getElementById('factoryLogoPreview').src = '';
          document.getElementById('factoryLogoPreview').classList.add('hidden');
        }
        
        showToast('Factory saved successfully!');
        loadFactories();
        loadFactoriesDropdown(); // Refresh dropdowns
        
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    async function loadFactories() {
      try {
        const snapshot = await db.collection('factories').orderBy('createdAt', 'desc').get();
        const list = document.getElementById('factoriesList');
        list.innerHTML = '';
        
        if (snapshot.empty) {
          list.innerHTML = '<p class="text-gray-500">No factories found</p>';
          return;
        }
        
        snapshot.forEach(doc => {
          const factory = doc.data();
          const defaultLogo = 'https://via.placeholder.com/80x80?text=' + encodeURIComponent(factory.name.substring(0, 2).toUpperCase());
          
          list.innerHTML += `
            <div class="border p-4 rounded-lg">
              <div class="flex justify-between items-start">
                <div class="flex gap-2">
                  <div class="flex-shrink-0">
                    <img src="${factory.logo || defaultLogo}" 
                         alt="${factory.name} logo" 
                         onerror="this.src='${defaultLogo}'"
                         class="w-20 h-20 object-cover rounded-lg border">
                  </div>
                  <div>
                    <h3 class="font-semibold text-lg">${factory.name}</h3>
                    <p class="text-gray-600">${factory.category}</p>
                    <p class="text-sm text-gray-500 mt-2">
                      <i class="fas fa-map-marker-alt mr-1"></i>${factory.address}<br>
                      <i class="fas fa-phone mr-1"></i>${factory.phone}<br>
                      <i class="fas fa-envelope mr-1"></i>${factory.email}
                      ${factory.website ? `<br><i class="fas fa-globe mr-1"></i><a href="${factory.website}" target="_blank" class="text-blue-600 hover:underline">${factory.website}</a>` : ''}
                    </p>
                  </div>
                </div>
                <div class="flex">
                 <button onclick="editFactory('${doc.id}')" class="text-blue-500 hover:text-blue-700 mr-1">
                 <i class="fas fa-edit"></i>
                  </button>
                  <button onclick="deleteFactory('${doc.id}')" class="text-red-500 hover:text-red-700">
                   <i class="fas fa-trash"></i>
                   </button>
                 </div>
              </div>
            </div>
          `;
        });
      } catch (error) {
        console.error('Error loading factories:', error);
      }
    }

    function handleFactoryLogoUpload() {
      const file = document.getElementById('factoryLogoFile').files[0];
      if (file) {
        if (file.size > 2 * 1024 * 1024) {
          showToast('Logo file size must be less than 2MB', 'error');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('factoryLogoPreview').src = e.target.result;
          document.getElementById('factoryLogoPreview').classList.remove('hidden');
          document.getElementById('factoryLogo').value = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    }

    async function editFactory(id) {
  const doc = await db.collection('factories').doc(id).get();
  const factory = doc.data();
  
  // Existing form fields use karo
  document.getElementById('factoryName').value = factory.name;
  document.getElementById('factoryCategory').value = factory.category;
  document.getElementById('factoryAddress').value = factory.address;
  document.getElementById('factoryPhone').value = factory.phone;
  document.getElementById('factoryEmail').value = factory.email;
  document.getElementById('factoryWebsite').value = factory.website || '';
  document.getElementById('factoryLogo').value = factory.logo || '';
  
  // Save button ko Update mein change karo
  const saveBtn = document.querySelector('button[onclick="saveFactory()"]');
  saveBtn.textContent = 'Update Factory';
  saveBtn.setAttribute('onclick', `updateFactory('${id}')`);
}

async function updateFactory(id) {
  // Same as saveFactory, bas update use karo
  await db.collection('factories').doc(id).update({
    name: document.getElementById('factoryName').value,
    // ... baaki fields
  });
  
  showToast('Updated!');
  location.reload(); // Simple page refresh
}

    async function deleteFactory(id) {
      if (!confirm('Are you sure you want to delete this factory?')) return;
      
      try {
        showLoading();
        await db.collection('factories').doc(id).delete();
        showToast('Factory deleted successfully!');
        loadFactories();
        loadFactoriesDropdown(); // Refresh dropdowns
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    

    // Event Management Functions
    async function saveEvent() {
      const title = document.getElementById('eventTitle').value.trim();
      const type = document.getElementById('eventType').value;
      const date = document.getElementById('eventDate').value;
      const time = document.getElementById('eventTime').value;
      const location = document.getElementById('eventLocation').value.trim();
      const organizer = document.getElementById('eventOrganizer').value.trim();
      const description = document.getElementById('eventDescription').value.trim();
      const image = document.getElementById('eventImage').value.trim();
      const registrationLink = document.getElementById('eventRegistrationLink').value.trim();
      const isActive = document.getElementById('eventIsActive').checked;
      
      if (!title || !type || !date || !location || !description) {
        showToast('Please fill all required fields', 'error');
        return;
      }
      
      try {
        showLoading();
        
        const eventData = {
          title,
          type,
          date,
          time: time || '00:00',
          location,
          organizer: organizer || 'SialConnect',
          description,
          image: image || 'https://via.placeholder.com/600x300?text=Event',
          registrationLink,
          isActive,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: auth.currentUser.email
        };
        
        await db.collection('events').add(eventData);
        
        // Clear form
        ['eventTitle', 'eventType', 'eventDate', 'eventTime', 'eventLocation', 'eventOrganizer', 'eventDescription', 'eventImage', 'eventRegistrationLink'].forEach(id => {
          document.getElementById(id).value = '';
        });
        document.getElementById('eventIsActive').checked = true;
        
        showToast('Event created successfully!');
        loadEvents();
        
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    async function loadEvents() {
      try {
        const filter = document.getElementById('eventFilter')?.value || 'all';
        let query = db.collection('events').orderBy('date', 'desc');
        
        if (filter === 'active') {
          query = query.where('isActive', '==', true);
        }
        
        const snapshot = await query.get();
        const list = document.getElementById('eventsList');
        list.innerHTML = '';
        
        if (snapshot.empty) {
          list.innerHTML = '<p class="text-gray-500">No events found</p>';
          return;
        }
        
        const today = new Date().toISOString().split('T')[0];
        
        snapshot.forEach(doc => {
          const event = doc.data();
          const isPast = event.date < today;
          const statusBadge = event.isActive && !isPast ? 
            '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Active</span>' : 
            '<span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">Inactive</span>';
          
          list.innerHTML += `
            <div class="border p-4 rounded-lg ${isPast ? 'bg-gray-50' : ''}">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-2">
                    <h3 class="font-semibold text-lg">${event.title}</h3>
                    ${statusBadge}
                    <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${event.type}</span>
                  </div>
                  <p class="text-gray-600 mb-1"><i class="fas fa-calendar mr-2"></i>${event.date} ${event.time}</p>
                  <p class="text-gray-600 mb-1"><i class="fas fa-map-marker-alt mr-2"></i>${event.location}</p>
                  <p class="text-gray-600 mb-2"><i class="fas fa-user mr-2"></i>${event.organizer}</p>
                  <p class="text-sm text-gray-700">${event.description.substring(0, 150)}${event.description.length > 150 ? '...' : ''}</p>
                  ${event.registrationLink ? `<a href="${event.registrationLink}" target="_blank" class="text-blue-600 text-sm hover:underline mt-2 inline-block">Registration Link</a>` : ''}
                </div>
                <div class="flex gap-2">
                  <button onclick="toggleEventStatus('${doc.id}', ${event.isActive})" class="text-yellow-500 hover:text-yellow-700">
                    <i class="fas fa-toggle-${event.isActive ? 'on' : 'off'}"></i>
                  </button>
                  <button onclick="deleteEvent('${doc.id}')" class="text-red-500 hover:text-red-700">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          `;
        });
      } catch (error) {
        console.error('Error loading events:', error);
      }
    }

    async function toggleEventStatus(id, currentStatus) {
      try {
        showLoading();
        await db.collection('events').doc(id).update({
          isActive: !currentStatus
        });
        showToast('Event status updated!');
        loadEvents();
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    async function deleteEvent(id) {
      if (!confirm('Are you sure you want to delete this event?')) return;
      
      try {
        showLoading();
        await db.collection('events').doc(id).delete();
        showToast('Event deleted successfully!');
        loadEvents();
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    // Notification Management Functions
    async function sendNotification() {
      const title = document.getElementById('notificationTitle').value.trim();
      const type = document.getElementById('notificationType').value;
      const message = document.getElementById('notificationMessage').value.trim();
      const target = document.getElementById('notificationTarget').value;
      const targetValue = document.getElementById('notificationTargetValue').value.trim();
      const priority = document.getElementById('notificationPriority').value;
      const link = document.getElementById('notificationLink').value.trim();
      
      if (!title || !type || !message) {
        showToast('Please fill all required fields', 'error');
        return;
      }
      
      if (target === 'specific' && !targetValue) {
        showToast('Please enter user email for specific notification', 'error');
        return;
      }
      
      try {
        showLoading();
        
        const notificationData = {
          title,
          type,
          message,
          target,
          targetValue: targetValue || null,
          priority,
          link: link || null,
          isRead: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: auth.currentUser.email
        };
        
        const notificationRef = await db.collection('notifications').add(notificationData);
        
        if (target === 'all') {
          const usersSnapshot = await db.collection('users').get();
          const batch = db.batch();
          
          usersSnapshot.forEach(userDoc => {
            const userNotifRef = db.collection('user_notifications').doc();
            batch.set(userNotifRef, {
              ...notificationData,
              userId: userDoc.id,
              userEmail: userDoc.data().email,
              notificationId: notificationRef.id
            });
          });
          
          await batch.commit();
        } else if (target === 'specific') {
          const userQuery = await db.collection('users').where('email', '==', targetValue).get();
          if (!userQuery.empty) {
            const userDoc = userQuery.docs[0];
            await db.collection('user_notifications').add({
              ...notificationData,
              userId: userDoc.id,
              userEmail: targetValue,
              notificationId: notificationRef.id
            });
          }
        }
        
        // Clear form
        ['notificationTitle', 'notificationType', 'notificationMessage', 'notificationTargetValue', 'notificationLink'].forEach(id => {
          document.getElementById(id).value = '';
        });
        document.getElementById('notificationTarget').value = 'all';
        document.getElementById('notificationPriority').value = 'low';
        
        showToast('Notification sent successfully!');
        loadNotifications();
        
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    async function loadNotifications() {
      try {
        const snapshot = await db.collection('notifications').orderBy('createdAt', 'desc').limit(50).get();
        const list = document.getElementById('notificationsList');
        list.innerHTML = '';
        
        if (snapshot.empty) {
          list.innerHTML = '<p class="text-gray-500">No notifications sent yet</p>';
          return;
        }
        
        snapshot.forEach(doc => {
          const notification = doc.data();
          const typeColor = {
            info: 'blue',
            alert: 'red',
            success: 'green',
            warning: 'yellow',
            promotion: 'purple',
            update: 'indigo'
          }[notification.type] || 'gray';
          
          const priorityBadge = {
            low: '<span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">Low</span>',
            medium: '<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">Medium</span>',
            high: '<span class="bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded">High</span>',
            urgent: '<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded">Urgent</span>'
          }[notification.priority];
          
          const createdAt = notification.createdAt ? new Date(notification.createdAt.toDate()).toLocaleString() : 'Just now';
          
          list.innerHTML += `
            <div class="border-l-4 border-${typeColor}-500 p-4 rounded-lg bg-white shadow-sm">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-2">
                    <h3 class="font-semibold">${notification.title}</h3>
                    <span class="bg-${typeColor}-100 text-${typeColor}-800 text-xs px-2 py-1 rounded">${notification.type}</span>
                    ${priorityBadge}
                  </div>
                  <p class="text-gray-700 mb-2">${notification.message}</p>
                  <div class="text-xs text-gray-500">
                    <span class="mr-3"><i class="fas fa-user mr-1"></i>${notification.createdBy}</span>
                    <span class="mr-3"><i class="fas fa-clock mr-1"></i>${createdAt}</span>
                    <span><i class="fas fa-bullseye mr-1"></i>${notification.target === 'all' ? 'All Users' : notification.target === 'specific' ? `Specific: ${notification.targetValue}` : `Category: ${notification.targetValue}`}</span>
                  </div>
                  ${notification.link ? `<a href="${notification.link}" target="_blank" class="text-blue-600 text-sm hover:underline mt-2 inline-block">Action Link</a>` : ''}
                </div>
                <button onclick="deleteNotification('${doc.id}')" class="text-red-500 hover:text-red-700">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          `;
        });
      } catch (error) {
        console.error('Error loading notifications:', error);
      }
    }

    async function deleteNotification(id) {
      if (!confirm('Are you sure you want to delete this notification?')) return;
      
      try {
        showLoading();
        await db.collection('notifications').doc(id).delete();
        const userNotifs = await db.collection('user_notifications').where('notificationId', '==', id).get();
        const batch = db.batch();
        userNotifs.forEach(doc => {
          batch.delete(doc.ref);
        });
        await batch.commit();
        
        showToast('Notification deleted successfully!');
        loadNotifications();
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    // Dashboard and User Functions
    async function loadDashboard() {
  try {
    // Check if users collection exists, otherwise use auth
    let userCount = 0;
    try {
      const usersSnapshot = await db.collection('users').get();
      userCount = usersSnapshot.size;
    } catch (error) {
      // If users collection doesn't exist, count from auth users
      // Note: Firebase Auth doesn't provide direct user count
      console.log('Users collection not found, defaulting to 0');
      userCount = 0;
    }
    
    const [categories, factories, events, notifications] = await Promise.all([
      db.collection('categories').get(),
      db.collection('factories').get(),
      db.collection('events').where('isActive', '==', true).get(),
      db.collection('notifications').get()
    ]);
    
    document.getElementById('categoryCount').textContent = categories.size;
    document.getElementById('factoryCount').textContent = factories.size;
    document.getElementById('userCount').textContent = userCount;
    document.getElementById('eventCount').textContent = events.size;
    document.getElementById('notificationCount').textContent = notifications.size;
    
  } catch (error) {
    console.error('Error loading dashboard:', error);
    // Set default values on error
    document.getElementById('categoryCount').textContent = '0';
    document.getElementById('factoryCount').textContent = '0';
    document.getElementById('userCount').textContent = '0';
    document.getElementById('eventCount').textContent = '0';
    document.getElementById('notificationCount').textContent = '0';
  }
}

    async function loadUsers() {
      try {
        const snapshot = await db.collection('users').orderBy('email').get();
        const list = document.getElementById('usersList');
        list.innerHTML = '';
        
        if (snapshot.empty) {
          list.innerHTML = '<p class="text-gray-500">No users found</p>';
          return;
        }
        
        snapshot.forEach(doc => {
          const user = doc.data();
          const createdAt = user.createdAt ? new Date(user.createdAt.toDate()).toLocaleDateString() : 'Unknown';
          
          list.innerHTML += `
            <div class="border p-4 rounded-lg">
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold">${user.email || user.name || 'Unknown User'}</p>
                  <p class="text-sm text-gray-500">ID: ${doc.id}</p>
                  <p class="text-sm text-gray-500">Joined: ${createdAt}</p>
                  ${user.phone ? `<p class="text-sm text-gray-500">Phone: ${user.phone}</p>` : ''}
                </div>
              </div>
            </div>
          `;
        });
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    // Auth State Observer
    auth.onAuthStateChanged((user) => {
      if (user) {
        document.getElementById('loginModal').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
        hideLoading();
        loadDashboard();
      } else {
        document.getElementById('loginModal').classList.remove('hidden');
        document.getElementById('mainContent').classList.add('hidden');
        hideLoading();
      }
    });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Set default section visibility
      showSection('dashboard');
    });

    // Handle Enter key for login
    document.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && !document.getElementById('loginModal').classList.contains('hidden')) {
        handleLogin();
      }
    });
  </script>
</body>
</html>